#!/bin/sh

# LTE Modem initialization script for Huawei E3372h
# Switches modem from CD-ROM mode to modem mode and configures network

case "$1" in
    start)
        echo "Starting LTE modem initialization..."
        
        # Wait for USB device to be detected
        sleep 5
        
        # Check if modem is in CD-ROM mode (12d1:1f01)
        if lsusb | grep -q "12d1:1f01"; then
            echo "Found Huawei E3372h in CD-ROM mode, switching to modem mode..."
            
            # Switch to modem mode using -J flag for E3372h
            usb_modeswitch -v 12d1 -p 1f01 -J
            
            # Wait for mode switch
            sleep 10
            
            # Verify modem mode
            if lsusb | grep -q "12d1:14dc"; then
                echo "Successfully switched to modem mode"
                
                # Look for network interface (usually named usb0, eth1, or similar)
                for i in $(seq 1 30); do
                    # Check for new network interfaces
                    for iface in usb0 eth1 eth2 wwan0; do
                        if ip link show $iface 2>/dev/null | grep -q "state"; then
                            echo "Found network interface: $iface"
                            
                            # Configure the interface
                            ip link set $iface up
                            
                            # Start DHCP client
                            udhcpc -i $iface &
                            
                            echo "LTE modem configured on interface $iface"
                            exit 0
                        fi
                    done
                    
                    echo "Waiting for network interface... ($i/30)"
                    sleep 2
                done
                
                echo "Warning: No network interface found for LTE modem"
            else
                echo "Error: Failed to switch modem to modem mode"
            fi
        else
            echo "Modem not found or already in modem mode"
        fi
        ;;
    stop)
        echo "Stopping LTE services..."
        # Kill any running udhcpc for LTE interfaces
        pkill -f "udhcpc.*usb0"
        pkill -f "udhcpc.*eth1"
        pkill -f "udhcpc.*eth2"
        pkill -f "udhcpc.*wwan0"
        ;;
    restart)
        $0 stop
        sleep 2
        $0 start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
        ;;
esac

exit 0
